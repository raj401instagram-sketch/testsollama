name: Ollama Server with Tunneling (20min Keep-Alive fixed all)

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Model to load (e.g., qwen2.5:7b, llama3.1:8b)'
        required: true
        default: 'qwen3:0.6b'
        type: string
      test_prompt:
        description: 'Test prompt after model loads'
        required: false
        default: 'Hello! Please respond with your model name and capabilities.'
        type: string

env:
  OLLAMA_HOST: 0.0.0.0:11543
  OLLAMA_MODELS: /home/runner/.ollama/models
  WEBHOOK_URL: https://n8n-latest-l4cl.onrender.com/webhook/034c8802-f6d2-4819-b1fc-04b90835c013

jobs:
  ollama-server:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ðŸš€ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“Š System Information & Setup
      run: |
        echo "==================== SYSTEM INFO ===================="
        echo "ðŸ• Workflow started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ðŸ–¥ï¸  Runner OS: $(uname -a)"
        echo "ðŸ’¾ Memory Info:"
        free -h
        echo "ðŸ”§ CPU Info:"
        nproc
        lscpu | grep "Model name"
        echo "ðŸ’¿ Disk Info:"
        df -h /
        echo "ðŸ‘¤ User Info:"
        whoami
        id
        echo "ðŸŒ Network Info:"
        ip route show default
        echo "=================================================="
        
        # Create logs directory with proper permissions
        mkdir -p logs
        chmod 755 logs
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Workflow started" >> logs/timeline.log
        
        # Create .ollama directory with proper permissions
        mkdir -p /home/runner/.ollama
        chmod 755 /home/runner/.ollama
        
    - name: ðŸ“¦ Cache Ollama Models Directory
      id: cache-ollama-models
      uses: actions/cache@v4
      with:
        path: /home/runner/.ollama
        key: ollama-models-${{ runner.os }}-${{ github.event.inputs.model }}-v2
        restore-keys: |
          ollama-models-${{ runner.os }}-${{ github.event.inputs.model }}-
          ollama-models-${{ runner.os }}-
          
    - name: ðŸ“¦ Cache Ollama Binary
      id: cache-ollama-bin
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/ollama
        key: ollama-binary-${{ runner.os }}-v2
        
    - name: ðŸ“¦ Cache Cloudflare Tunnel Binary
      id: cache-cloudflared-bin
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/cloudflared
        key: cloudflared-binary-${{ runner.os }}-v2
        
    - name: â¬‡ï¸ Install Ollama
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Installing Ollama" >> logs/timeline.log
        
        # Check if cached binary is valid
        if [[ "${{ steps.cache-ollama-bin.outputs.cache-hit }}" == "true" ]] && [[ -f /usr/local/bin/ollama ]]; then
          echo "âœ… Ollama binary restored from cache"
          if /usr/local/bin/ollama --version; then
            echo "âœ… Cached binary is valid"
          else
            echo "âŒ Cached binary corrupted, reinstalling..."
            sudo rm -f /usr/local/bin/ollama
          fi
        fi
        
        # Install if not cached or corrupted
        if [[ ! -f /usr/local/bin/ollama ]]; then
          echo "ðŸ“¥ Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
        fi
        
        # Verify installation
        ollama --version
        which ollama
        ls -la /usr/local/bin/ollama
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Ollama installation completed" >> logs/timeline.log
        
    - name: ðŸ”§ Install Cloudflare Tunnel
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Installing cloudflared" >> logs/timeline.log
        
        # Check if cached binary is valid
        if [[ "${{ steps.cache-cloudflared-bin.outputs.cache-hit }}" == "true" ]] && [[ -f /usr/local/bin/cloudflared ]]; then
          echo "âœ… Cloudflared binary restored from cache"
          if /usr/local/bin/cloudflared --version; then
            echo "âœ… Cached binary is valid"
            echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Cloudflared installation completed" >> logs/timeline.log
            exit 0
          else
            echo "âŒ Cached binary corrupted, cleaning up..."
            sudo rm -f /usr/local/bin/cloudflared
          fi
        fi
        
        # Install if not cached or corrupted
        if [[ ! -f /usr/local/bin/cloudflared ]]; then
          echo "ðŸ“¥ Installing Cloudflared..."
          
          # Clean up any existing installations first
          sudo apt-get remove -y cloudflared 2>/dev/null || true
          sudo rm -f /usr/local/bin/cloudflared
          
          # Update package lists
          sudo apt-get update -qq
          
          # Download and install cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb || sudo apt-get install -f -y
        fi
        
        cloudflared --version
        echo "âœ… Cloudflared installed successfully"
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Cloudflared installation completed" >> logs/timeline.log
        
    - name: ðŸ§¹ Cleanup & Prepare Environment
      run: |
        echo "ðŸ§¹ Cleaning up environment..."
        
        # Kill any existing processes
        sudo pkill -f ollama || echo "No existing Ollama processes"
        sudo pkill -f cloudflared || echo "No existing cloudflared processes"
        
        # Wait for cleanup
        sleep 3
        
        # Verify no processes are running
        ps aux | grep -E "(ollama|cloudflared)" | grep -v grep || echo "âœ… Environment clean"
        
        # Ensure proper permissions for .ollama directory
        sudo chown -R runner:runner /home/runner/.ollama
        chmod -R 755 /home/runner/.ollama
        
        # Set environment variables for Ollama
        export OLLAMA_HOST=0.0.0.0:11543
        export OLLAMA_MODELS=/home/runner/.ollama/models
        export OLLAMA_ORIGINS="*"
        
        echo "âœ… Environment prepared"
        
    - name: ðŸš€ Start Ollama Server
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Starting Ollama server" >> logs/timeline.log
        echo "ðŸš€ Starting Ollama server..."
        
        # Set environment variables
        export OLLAMA_HOST=0.0.0.0:11543
        export OLLAMA_MODELS=/home/runner/.ollama/models
        export OLLAMA_ORIGINS="*"
        export OLLAMA_KEEP_ALIVE=30m
        
        # Start Ollama server in background
        nohup ollama serve > logs/ollama-server.log 2>&1 &
        OLLAMA_PID=$!
        echo $OLLAMA_PID > logs/ollama.pid
        
        echo "ðŸ“‹ Ollama PID: $OLLAMA_PID"
        echo "â³ Waiting for Ollama to start..."
        
        # Wait for Ollama to be ready with better error handling
        for i in {1..45}; do
          if curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
            echo "âœ… Ollama server is ready!"
            echo "ðŸ“‹ Ollama responding on port 11543"
            break
          fi
          
          if [[ $i -eq 45 ]]; then
            echo "âŒ Ollama failed to start after 45 attempts"
            echo "ðŸ“‹ Server logs:"
            tail -20 logs/ollama-server.log 2>/dev/null || echo "No server logs found"
            echo "ðŸ“‹ Process status:"
            ps aux | grep ollama | grep -v grep || echo "No Ollama process found"
            exit 1
          fi
          
          echo "â³ Attempt $i/45: Waiting for Ollama... ($(date '+%H:%M:%S'))"
          sleep 3
        done
        
        # Verify server is properly bound
        echo "ðŸ“‹ Network status:"
        netstat -tlnp | grep 11543 || echo "Port 11543 not found in netstat"
        
        echo "ðŸ“‹ Testing local connection:"
        curl -v http://0.0.0.0:11543/api/tags 2>&1 | head -10
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Ollama server started successfully" >> logs/timeline.log
        
    - name: ðŸŒ Setup Cloudflare Tunnel
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Setting up tunnel" >> logs/timeline.log
        echo "ðŸŒ Starting Cloudflare tunnel..."
        
        # Start tunnel in background with proper error handling
        nohup cloudflared tunnel --url http://0.0.0.0:11543 --no-autoupdate > logs/tunnel.log 2>&1 &
        TUNNEL_PID=$!
        echo $TUNNEL_PID > logs/tunnel.pid
        
        echo "ðŸ“‹ Tunnel PID: $TUNNEL_PID"
        echo "â³ Waiting for tunnel to establish..."
        
        # Wait for tunnel URL with improved parsing
        TUNNEL_URL=""
        for i in {1..90}; do
          if [[ -f logs/tunnel.log ]]; then
            # Look for the tunnel URL in various formats
            TUNNEL_URL=$(grep -oE 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' logs/tunnel.log | head -1)
            
            if [[ ! -z "$TUNNEL_URL" ]]; then
              echo "âœ… Tunnel established: $TUNNEL_URL"
              echo "$TUNNEL_URL" > logs/tunnel_url.txt
              
              # Test tunnel connectivity
              sleep 5
              if curl -sf "$TUNNEL_URL/api/tags" >/dev/null 2>&1; then
                echo "âœ… Tunnel is accessible and working"
                break
              else
                echo "âš ï¸  Tunnel URL found but not accessible yet, continuing to wait..."
              fi
            fi
          fi
          
          if [[ $i -eq 90 ]]; then
            echo "âŒ Failed to establish tunnel after 90 attempts"
            echo "ðŸ“‹ Tunnel logs:"
            cat logs/tunnel.log 2>/dev/null || echo "No tunnel logs found"
            echo "ðŸ“‹ Process status:"
            ps aux | grep cloudflared | grep -v grep || echo "No cloudflared process found"
            exit 1
          fi
          
          echo "â³ Attempt $i/90: Waiting for tunnel URL... ($(date '+%H:%M:%S'))"
          sleep 2
        done
        
        echo "ðŸŒ Public Ollama URL: $TUNNEL_URL"
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Tunnel established: $TUNNEL_URL" >> logs/timeline.log
        
    - name: ðŸ“¥ Load Model with Enhanced Caching
      run: |
        # Use custom model if provided, otherwise use default
        MODEL_NAME="${{ github.event.inputs.model || 'qwen2.5:7b' }}"
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Loading model: $MODEL_NAME" >> logs/timeline.log
        echo "ðŸ“¥ Loading model: $MODEL_NAME"
        
        # Set environment for ollama commands
        export OLLAMA_HOST=0.0.0.0:11543
        
        # Check current models
        echo "ðŸ“‹ Checking available models:"
        ollama list || echo "No models currently available"
        
        # Check if model exists in cache
        MODEL_EXISTS=false
        if ollama list | grep -q "$MODEL_NAME"; then
          echo "âœ… Model found in local cache"
          MODEL_EXISTS=true
        else
          echo "ðŸ“¥ Model not found, will download..."
        fi
        
        # Download model if needed
        if [[ "$MODEL_EXISTS" == "false" ]]; then
          echo "ðŸ“¥ Downloading model: $MODEL_NAME"
          echo "âš ï¸  This may take several minutes for large models..."
          
          # Start memory monitoring
          nohup bash -c 'while true; do echo "$(date): $(free -h | grep Mem:)" >> logs/memory-monitor.log; sleep 30; done' &
          MONITOR_PID=$!
          echo $MONITOR_PID > logs/monitor.pid
          
          # Download with extended timeout and retry logic
          DOWNLOAD_SUCCESS=false
          for attempt in {1..3}; do
            echo "ðŸ“¥ Download attempt $attempt/3..."
            if timeout 1200 ollama pull "$MODEL_NAME"; then
              DOWNLOAD_SUCCESS=true
              break
            else
              echo "âš ï¸  Download attempt $attempt failed, retrying..."
              sleep 10
            fi
          done
          
          # Stop monitoring
          kill $MONITOR_PID 2>/dev/null || true
          
          if [[ "$DOWNLOAD_SUCCESS" == "false" ]]; then
            echo "âŒ Failed to download model after 3 attempts"
            exit 1
          fi
          
          echo "âœ… Model downloaded successfully"
        fi
        
        # Verify model is loaded
        echo "ðŸ“‹ Final model list:"
        ollama list
        
        # Pre-load model to ensure it's ready
        echo "ðŸ”„ Pre-loading model for faster responses..."
        timeout 60 ollama run "$MODEL_NAME" "test" >/dev/null 2>&1 || echo "Pre-load completed"
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Model loading completed" >> logs/timeline.log
        
    - name: ðŸ“¡ Send Webhook Notification
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Sending webhook notification" >> logs/timeline.log
        
        TUNNEL_URL=$(cat logs/tunnel_url.txt)
        MODEL_NAME="${{ github.event.inputs.model || 'qwen2.5:7b' }}"
        
        # Create comprehensive webhook payload
        WEBHOOK_PAYLOAD=$(jq -n \
          --arg event "ollama_server_ready" \
          --arg timestamp "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
          --arg workflow_run_id "${{ github.run_id }}" \
          --arg repository "${{ github.repository }}" \
          --arg model "$MODEL_NAME" \
          --arg ollama_url "$TUNNEL_URL" \
          --arg status "running" \
          --arg uptime "20 minutes" \
          '{
            event: $event,
            timestamp: $timestamp,
            workflow_run_id: $workflow_run_id,
            repository: $repository,
            model: $model,
            ollama_url: $ollama_url,
            api_endpoints: {
              generate: ($ollama_url + "/api/generate"),
              chat: ($ollama_url + "/api/chat"),
              embeddings: ($ollama_url + "/api/embeddings"),
              models: ($ollama_url + "/api/tags"),
              show: ($ollama_url + "/api/show"),
              ps: ($ollama_url + "/api/ps")
            },
            server_status: $status,
            estimated_uptime: $uptime,
            runner_info: {
              os: "ubuntu-latest",
              memory: "32GB",
              host: "0.0.0.0:11543"
            }
          }'
        )
        
        echo "ðŸ“¡ Sending webhook notification..."
        echo "ðŸ“‹ Payload preview:"
        echo "$WEBHOOK_PAYLOAD" | jq '.'
        
        # Send webhook with enhanced retry logic
        WEBHOOK_SENT=false
        for i in {1..5}; do
          if curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$WEBHOOK_PAYLOAD" \
            --max-time 30 \
            --retry 1 \
            --retry-delay 5 \
            -w "HTTP: %{http_code}, Time: %{time_total}s\n"; then
            echo "âœ… Webhook sent successfully (attempt $i)"
            WEBHOOK_SENT=true
            break
          else
            echo "âš ï¸  Webhook attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
        done
        
        if [[ "$WEBHOOK_SENT" == "false" ]]; then
          echo "âŒ All webhook attempts failed, continuing without notification"
        fi
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Webhook notification completed" >> logs/timeline.log
        
    - name: ðŸ“Š Setup Lightweight Monitoring
      run: |
        echo "ðŸ“Š Setting up lightweight monitoring..."
        
        # Create simplified monitoring script
        cat > monitor.sh << 'EOF'
        #!/bin/bash
        LOG_FILE="logs/monitor.log"
        
        while true; do
          echo "=== $(date -u '+%Y-%m-%d %H:%M:%S UTC') ===" >> "$LOG_FILE"
          
          # Memory status
          echo "Memory Usage:" >> "$LOG_FILE"
          free -h >> "$LOG_FILE"
          
          # Top processes by memory
          echo "Top Memory Processes:" >> "$LOG_FILE"
          ps aux --sort=-%mem | head -5 >> "$LOG_FILE"
          
          # Simple Ollama status check (no API calls)
          echo "Ollama Process Status:" >> "$LOG_FILE"
          if pgrep -f ollama >/dev/null; then
            echo "âœ… Ollama process running" >> "$LOG_FILE"
          else
            echo "âŒ Ollama process not found" >> "$LOG_FILE"
          fi
          
          # Simple tunnel status check (no API calls)
          echo "Tunnel Process Status:" >> "$LOG_FILE"
          if pgrep -f cloudflared >/dev/null; then
            echo "âœ… Tunnel process running" >> "$LOG_FILE"
          else
            echo "âŒ Tunnel process not found" >> "$LOG_FILE"
          fi
          
          echo "============================================" >> "$LOG_FILE"
          sleep 60
        done
        EOF
        
        chmod +x monitor.sh
        nohup ./monitor.sh &
        MONITOR_PID=$!
        echo $MONITOR_PID > logs/monitor.pid
        
        echo "âœ… Lightweight monitoring started (PID: $MONITOR_PID)"
        
    
    - name: â° Keep Server Alive (20 Minutes)
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Starting 20-minute keep-alive" >> logs/timeline.log
        echo "â° Keeping server alive for 20 minutes..."
        echo "ðŸŒ Server accessible at: $(cat logs/tunnel_url.txt)"
        
        START_TIME=$(date +%s)
        DURATION=$((20 * 60))  # 20 minutes
        
        echo "ðŸ“Š Starting lightweight keep-alive loop..."
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          REMAINING=$((DURATION - ELAPSED))
          
          if [[ $REMAINING -le 0 ]]; then
            echo "â° 20 minutes completed, ending keep-alive"
            break
          fi
          
          MINUTES_LEFT=$((REMAINING / 60))
          SECONDS_LEFT=$((REMAINING % 60))
          
          echo "â° Server active... Time remaining: ${MINUTES_LEFT}m ${SECONDS_LEFT}s ($(date '+%H:%M:%S'))"
          
          # Basic process checks only (no API calls for speed)
          if ! pgrep -f ollama >/dev/null; then
            echo "âŒ Ollama process not found!"
          fi
          
          if ! pgrep -f cloudflared >/dev/null; then
            echo "âŒ Tunnel process not found!"
          fi
          
          # Status report every 5 minutes
          if [[ $((ELAPSED % 300)) -eq 0 ]] && [[ $ELAPSED -gt 0 ]]; then
            echo "ðŸ“Š 5-minute status report ($(date -u '+%Y-%m-%d %H:%M:%S UTC')):"
            echo "  ðŸ’¾ Memory: $(free -h | grep Mem: | awk '{print $3"/"$2}')"
            echo "  ðŸ–¥ï¸  CPU Load: $(uptime | awk -F'load average:' '{ print $2 }')"
            echo "  ðŸ”¥ Top process: $(ps aux --sort=-%mem | head -2 | tail -1 | awk '{print $11}')"
          fi
          
          sleep 30
        done
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Keep-alive completed" >> logs/timeline.log
        
    - name: ðŸ“Š Final Status Report
      if: always()
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Generating final report" >> logs/timeline.log
        
        echo "==================== FINAL STATUS REPORT ===================="
        echo "ðŸ• Workflow ending at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # Server status
        echo "ðŸ–¥ï¸  Final server status:"
        if curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
          echo "  âœ… Ollama server: Running"
        else
          echo "  âŒ Ollama server: Not responding"
        fi
        
        # Tunnel status
        TUNNEL_URL=$(cat logs/tunnel_url.txt 2>/dev/null)
        if [[ ! -z "$TUNNEL_URL" ]]; then
          if curl -sf "$TUNNEL_URL/api/tags" >/dev/null 2>&1; then
            echo "  âœ… Tunnel: Accessible"
          else
            echo "  âŒ Tunnel: Not accessible"
          fi
          echo "  ðŸŒ Final URL: $TUNNEL_URL"
        else
          echo "  âŒ Tunnel: URL not found"
        fi
        
        # Resource usage
        echo "ðŸ’¾ Final memory status:"
        free -h
        
        echo "ðŸ”„ Process status:"
        ps aux | grep -E "(ollama|cloudflared)" | grep -v grep || echo "  No processes found"
        
        # Model status
        echo "ðŸ“‹ Final model list:"
        OLLAMA_HOST=0.0.0.0:11543 ollama list 2>/dev/null || echo "  Could not retrieve model list"
        
        # Cache information
        echo "ðŸ’¾ Cache status:"
        echo "  ðŸ“¦ Ollama models cache: ${{ steps.cache-ollama-models.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
        echo "  ðŸ“¦ Ollama binary cache: ${{ steps.cache-ollama-bin.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
        
        # Files generated
        echo "ðŸ“ Generated files:"
        ls -la logs/ 2>/dev/null || echo "  No logs directory"
        
        echo "ðŸ“œ Complete timeline:"
        cat logs/timeline.log 2>/dev/null || echo "  No timeline log found"
        
        echo "============================================================"
        
    - name: ðŸ§¹ Cleanup Processes
      if: always()
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Starting cleanup" >> logs/timeline.log
        echo "ðŸ§¹ Cleaning up processes..."
        
        # Stop monitoring
        if [[ -f logs/monitor.pid ]]; then
          MONITOR_PID=$(cat logs/monitor.pid)
          kill $MONITOR_PID 2>/dev/null || true
          echo "âœ… Monitor process stopped"
        fi
        
        # Stop tunnel
        if [[ -f logs/tunnel.pid ]]; then
          TUNNEL_PID=$(cat logs/tunnel.pid)
          kill $TUNNEL_PID 2>/dev/null || true
          echo "âœ… Tunnel process stopped"
        fi
        
        # Stop Ollama gracefully
        if [[ -f logs/ollama.pid ]]; then
          OLLAMA_PID=$(cat logs/ollama.pid)
          kill $OLLAMA_PID 2>/dev/null || true
          echo "âœ… Ollama process stopped"
        fi
        
        # Wait for graceful shutdown
        sleep 5
        
        # Force kill any remaining processes
        sudo pkill -f cloudflared || true
        sudo pkill -f ollama || true
        
        echo "âœ… All processes cleaned up"
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Cleanup completed" >> logs/timeline.log
        
    - name: ðŸ’¾ Upload Comprehensive Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ollama-server-logs-${{ github.run_id }}
        path: logs/
        retention-days: 7
