name: Ollama Server with ngrok Tunnel

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Model to load (e.g., qwen2.5:7b, llama3.1:8b)'
        required: true
        default: 'qwen2.5:0.5b'
        type: string
      test_prompt:
        description: 'Test prompt after model loads'
        required: false
        default: 'Hello! Please respond with your model name and capabilities.'
        type: string
      ngrok_authtoken:
        description: 'ngrok Auth Token (leave empty to use secret)'
        required: false
        type: string

env:
  OLLAMA_HOST: 0.0.0.0:11543
  OLLAMA_MODELS: /home/runner/.ollama/models
  OLLAMA_KEEP_ALIVE: 65m
  WEBHOOK_URL: https://n8n-latest-l4cl.onrender.com/webhook/034c8802-f6d2-4819-b1fc-04b90835c013
  # Use input token if provided, otherwise use secret
  NGROK_AUTHTOKEN: ${{ github.event.inputs.ngrok_authtoken || secrets.NGROK_AUTHTOKEN }}

jobs:
  ollama-server:
    runs-on: ubuntu-latest
    timeout-minutes: 65
    
    steps:
    - name: 🚀 Checkout repository
      uses: actions/checkout@v4
      
    - name: 📊 System Information & Setup
      run: |
        echo "==================== SYSTEM INFO ===================="
        echo "🕐 Workflow started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "🖥️  Runner OS: $(uname -a)"
        echo "💾 Memory Info:"
        free -h
        echo "🔧 CPU Info:"
        nproc
        lscpu | grep "Model name"
        echo "💿 Disk Info:"
        df -h /
        echo "👤 User Info:"
        whoami
        id
        echo "🌐 Network Info:"
        ip route show default
        echo "=================================================="
        
        # Create logs directory with proper permissions
        mkdir -p logs
        chmod 755 logs
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Workflow started" >> logs/timeline.log
        
        # Create .ollama directory with proper permissions
        mkdir -p /home/runner/.ollama
        chmod 755 /home/runner/.ollama
        
    - name: 🔐 Validate ngrok Token
      run: |
        echo "🔐 Validating ngrok auth token..."
        
        if [[ -z "${{ env.NGROK_AUTHTOKEN }}" ]]; then
          echo "❌ ERROR: No ngrok auth token provided!"
          echo "Please either:"
          echo "1. Add NGROK_AUTHTOKEN to your repository secrets"
          echo "2. Provide a token via the workflow input"
          exit 1
        fi
        
        # Basic token format validation
        if [[ ${#NGROK_AUTHTOKEN} -lt 20 ]]; then
          echo "⚠️  Warning: Token appears too short. Please verify your ngrok authtoken."
        else
          echo "✅ Token format appears valid"
        fi
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Token validated" >> logs/timeline.log
        
    - name: 📦 Cache Ollama Models Directory
      id: cache-ollama-models
      uses: actions/cache@v4
      with:
        path: /home/runner/.ollama
        key: ollama-models-${{ runner.os }}-${{ github.event.inputs.model }}-v3
        restore-keys: |
          ollama-models-${{ runner.os }}-${{ github.event.inputs.model }}-
          ollama-models-${{ runner.os }}-
          
    - name: 📦 Cache Ollama Binary
      id: cache-ollama-bin
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/ollama
        key: ollama-binary-${{ runner.os }}-v3
        
    - name: ⬇️ Install Ollama
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Installing Ollama" >> logs/timeline.log
        
        # Check if cached binary is valid
        if [[ "${{ steps.cache-ollama-bin.outputs.cache-hit }}" == "true" ]] && [[ -f /usr/local/bin/ollama ]]; then
          echo "✅ Ollama binary restored from cache"
          if /usr/local/bin/ollama --version; then
            echo "✅ Cached binary is valid"
          else
            echo "❌ Cached binary corrupted, reinstalling..."
            sudo rm -f /usr/local/bin/ollama
          fi
        fi
        
        # Install if not cached or corrupted
        if [[ ! -f /usr/local/bin/ollama ]]; then
          echo "📥 Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
        fi
        
        # Verify installation
        ollama --version
        which ollama
        ls -la /usr/local/bin/ollama
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Ollama installation completed" >> logs/timeline.log
        
    - name: 🔧 Install ngrok
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Installing ngrok" >> logs/timeline.log
        echo "📥 Installing ngrok..."
        
        # Clean up any existing installations
        sudo apt-get remove -y ngrok 2>/dev/null || true
        sudo rm -f /usr/local/bin/ngrok
        
        # Install ngrok via apt
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
          | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null \
          && echo "deb https://ngrok-agent.s3.amazonaws.com bookworm main" \
          | sudo tee /etc/apt/sources.list.d/ngrok.list \
          && sudo apt update \
          && sudo apt install ngrok
        
        # Verify installation
        ngrok version
        which ngrok
        
        echo "✅ ngrok installed successfully"
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - ngrok installation completed" >> logs/timeline.log
        
    - name: 🧹 Cleanup & Prepare Environment
      run: |
        echo "🧹 Cleaning up environment..."
        
        # Kill any existing processes
        sudo pkill -f ollama || echo "No existing Ollama processes"
        sudo pkill -f ngrok || echo "No existing ngrok processes"
        
        # Wait for cleanup
        sleep 3
        
        # Verify no processes are running
        ps aux | grep -E "(ollama|ngrok)" | grep -v grep || echo "✅ Environment clean"
        
        # Ensure proper permissions for .ollama directory
        sudo chown -R runner:runner /home/runner/.ollama
        chmod -R 755 /home/runner/.ollama
        
        echo "✅ Environment prepared"
        
    - name: 🚀 Start Ollama Server
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Starting Ollama server" >> logs/timeline.log
        echo "🚀 Starting Ollama server..."
        
        # Set environment variables
        export OLLAMA_HOST=0.0.0.0:11543
        export OLLAMA_MODELS=/home/runner/.ollama/models
        export OLLAMA_ORIGINS="*"
        export OLLAMA_KEEP_ALIVE=30m
        
        # Start Ollama server in background
        nohup ollama serve > logs/ollama-server.log 2>&1 &
        OLLAMA_PID=$!
        echo $OLLAMA_PID > logs/ollama.pid
        
        echo "📋 Ollama PID: $OLLAMA_PID"
        echo "⏳ Waiting for Ollama to start..."
        
        # Wait for Ollama to be ready with better error handling
        for i in {1..45}; do
          if curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
            echo "✅ Ollama server is ready!"
            echo "📋 Ollama responding on port 11543"
            break
          fi
          
          if [[ $i -eq 45 ]]; then
            echo "❌ Ollama failed to start after 45 attempts"
            echo "📋 Server logs:"
            tail -20 logs/ollama-server.log 2>/dev/null || echo "No server logs found"
            echo "📋 Process status:"
            ps aux | grep ollama | grep -v grep || echo "No Ollama process found"
            exit 1
          fi
          
          echo "⏳ Attempt $i/45: Waiting for Ollama... ($(date '+%H:%M:%S'))"
          sleep 3
        done
        
        # Verify server is properly bound
        echo "📋 Network status:"
        netstat -tlnp 2>/dev/null | grep 11543 || ss -tlnp | grep 11543 || echo "Port 11543 status check"
        
        echo "📋 Testing local connection:"
        curl -v http://0.0.0.0:11543/api/tags 2>&1 | head -10
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Ollama server started successfully" >> logs/timeline.log
        
    - name: 🌐 Setup ngrok Tunnel
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Setting up ngrok tunnel" >> logs/timeline.log
        echo "🌐 Starting ngrok tunnel..."
        
        # Configure ngrok with authtoken
        ngrok config add-authtoken "${{ env.NGROK_AUTHTOKEN }}"
        
        # Start ngrok tunnel in background
        nohup ngrok http --url=game-scorpion-assuring.ngrok-free.app 11543 --log=stdout > logs/ngrok.log 2>&1 &
        NGROK_PID=$!
        echo $NGROK_PID > logs/ngrok.pid
        
        echo "📋 ngrok PID: $NGROK_PID"
        echo "⏳ Waiting for ngrok tunnel to establish..."
        
        # Wait for ngrok to be ready
        for i in {1..30}; do
          if curl -sf http://127.0.0.1:4040/api/tunnels >/dev/null 2>&1; then
            echo "✅ ngrok tunnel is ready!"
            break
          fi
          
          if [[ $i -eq 30 ]]; then
            echo "❌ ngrok failed to start after 30 attempts"
            echo "📋 ngrok logs:"
            tail -20 logs/ngrok.log 2>/dev/null || echo "No ngrok logs found"
            exit 1
          fi
          
          echo "⏳ Attempt $i/30: Waiting for ngrok... ($(date '+%H:%M:%S'))"
          sleep 2
        done
        
        # Get tunnel URL
        TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "🌐 Tunnel URL: $TUNNEL_URL"
        echo "$TUNNEL_URL" > logs/tunnel-url.txt
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - ngrok tunnel established: $TUNNEL_URL" >> logs/timeline.log
        
    - name: 📡 Send Webhook Notification
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Sending webhook notification" >> logs/timeline.log
        
        MODEL_NAME="${{ github.event.inputs.model || 'qwen2.5:0.5b' }}"
        
        # Get the tunnel URL
        TUNNEL_URL=""
        if [[ -f logs/tunnel-url.txt ]]; then
          TUNNEL_URL=$(cat logs/tunnel-url.txt)
        else
          # Fallback: try to get URL from ngrok API
          TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
        fi
        
        if [[ -z "$TUNNEL_URL" || "$TUNNEL_URL" == "null" ]]; then
          TUNNEL_INFO="ngrok tunnel active - unable to retrieve public URL"
        else
          TUNNEL_INFO="ngrok tunnel: $TUNNEL_URL"
        fi
        
        # Create comprehensive webhook payload
        WEBHOOK_PAYLOAD=$(jq -n \
          --arg event "ollama_server_ready" \
          --arg timestamp "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
          --arg workflow_run_id "${{ github.run_id }}" \
          --arg repository "${{ github.repository }}" \
          --arg model "$MODEL_NAME" \
          --arg tunnel_status "$TUNNEL_INFO" \
          --arg tunnel_url "$TUNNEL_URL" \
          --arg status "running" \
          --arg uptime "65 minutes" \
          '{
            event: $event,
            timestamp: $timestamp,
            workflow_run_id: $workflow_run_id,
            repository: $repository,
            model: $model,
            tunnel_status: $tunnel_status,
            tunnel_url: $tunnel_url,
            server_config: {
              host: "0.0.0.0:11543",
              local_endpoints: {
                generate: "http://0.0.0.0:11543/api/generate",
                chat: "http://0.0.0.0:11543/api/chat",
                embeddings: "http://0.0.0.0:11543/api/embeddings",
                models: "http://0.0.0.0:11543/api/tags",
                show: "http://0.0.0.0:11543/api/show",
                ps: "http://0.0.0.0:11543/api/ps"
              },
              public_endpoints: ($tunnel_url | if . != "" and . != null then {
                generate: (. + "/api/generate"),
                chat: (. + "/api/chat"),
                embeddings: (. + "/api/embeddings"),
                models: (. + "/api/tags"),
                show: (. + "/api/show"),
                ps: (. + "/api/ps")
              } else {} end)
            },
            server_status: $status,
            estimated_uptime: $uptime,
            runner_info: {
              os: "ubuntu-latest",
              memory: "32GB"
            },
            notes: "Using ngrok tunnel for public access. Tunnel URL provided in tunnel_url field."
          }'
        )
        
        echo "📡 Sending webhook notification..."
        echo "📋 Payload preview:"
        echo "$WEBHOOK_PAYLOAD" | jq '.'
        
        # Send webhook with enhanced retry logic
        WEBHOOK_SENT=false
        for i in {1..5}; do
          if curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$WEBHOOK_PAYLOAD" \
            --max-time 30 \
            --retry 1 \
            --retry-delay 5 \
            -w "HTTP: %{http_code}, Time: %{time_total}s\n"; then
            echo "✅ Webhook sent successfully (attempt $i)"
            WEBHOOK_SENT=true
            break
          else
            echo "⚠️  Webhook attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
        done
        
        if [[ "$WEBHOOK_SENT" == "false" ]]; then
          echo "❌ All webhook attempts failed, continuing without notification"
        fi
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Webhook notification completed" >> logs/timeline.log
        
    - name: 📊 Setup Monitoring
      run: |
        echo "📊 Setting up monitoring..."
        
        # Create monitoring script
        cat > monitor.sh << 'EOF'
        #!/bin/bash
        LOG_FILE="logs/monitor.log"
        
        while true; do
          echo "=== $(date -u '+%Y-%m-%d %H:%M:%S UTC') ===" >> "$LOG_FILE"
          
          # Memory status
          echo "Memory Usage:" >> "$LOG_FILE"
          free -h >> "$LOG_FILE"
          
          # CPU load
          echo "CPU Load:" >> "$LOG_FILE"
          uptime >> "$LOG_FILE"
          
          # Process checks
          echo "Process Status:" >> "$LOG_FILE"
          
          if pgrep -f ollama >/dev/null; then
            echo "✅ Ollama: Running (PID: $(pgrep -f ollama))" >> "$LOG_FILE"
            # Check if Ollama is responding
            if curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
              echo "  ✅ API: Responding" >> "$LOG_FILE"
            else
              echo "  ❌ API: Not responding" >> "$LOG_FILE"
            fi
          else
            echo "❌ Ollama: Not running" >> "$LOG_FILE"
          fi
          
          if pgrep -f ngrok >/dev/null; then
            echo "✅ ngrok: Running (PID: $(pgrep -f ngrok))" >> "$LOG_FILE"
            # Check tunnel URL
            TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
            if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" != "null" ]]; then
              echo "  ✅ Tunnel: $TUNNEL_URL" >> "$LOG_FILE"
            else
              echo "  ❌ Tunnel: URL not available" >> "$LOG_FILE"
            fi
          else
            echo "❌ ngrok: Not running" >> "$LOG_FILE"
          fi
          
          # Disk usage
          echo "Disk Usage:" >> "$LOG_FILE"
          df -h / | tail -1 >> "$LOG_FILE"
          
          echo "============================================" >> "$LOG_FILE"
          sleep 60
        done
        EOF
        
        chmod +x monitor.sh
        nohup ./monitor.sh &
        MONITOR_PID=$!
        echo $MONITOR_PID > logs/main-monitor.pid
        
        echo "✅ Monitoring started (PID: $MONITOR_PID)"
        
    - name: ⏰ Keep Server Alive (65 Minutes)
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Starting 65-minute keep-alive" >> logs/timeline.log
        echo "⏰ Keeping server alive for 65 minutes..."
        
        # Get and display tunnel URL
        TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
        if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" != "null" ]]; then
          echo "🌐 Server is accessible via ngrok tunnel: $TUNNEL_URL"
          echo "📌 API endpoints available at:"
          echo "  - Generate: $TUNNEL_URL/api/generate"
          echo "  - Chat: $TUNNEL_URL/api/chat"
          echo "  - Models: $TUNNEL_URL/api/tags"
        else
          echo "⚠️  Unable to retrieve tunnel URL. Check ngrok logs."
        fi
        
        START_TIME=$(date +%s)
        DURATION=$((65 * 60))  # 65 minutes
        
        echo "📊 Starting keep-alive loop..."
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          REMAINING=$((DURATION - ELAPSED))
          
          if [[ $REMAINING -le 0 ]]; then
            echo "⏰ 65 minutes completed, ending keep-alive"
            break
          fi
          
          MINUTES_LEFT=$((REMAINING / 60))
          SECONDS_LEFT=$((REMAINING % 60))
          
          echo "⏰ Server active... Time remaining: ${MINUTES_LEFT}m ${SECONDS_LEFT}s ($(date '+%H:%M:%S'))"
          
          # Health checks
          HEALTH_STATUS="✅"
          
          if ! pgrep -f ollama >/dev/null; then
            echo "❌ WARNING: Ollama process not found!"
            HEALTH_STATUS="❌"
            # Attempt to restart Ollama
            echo "🔄 Attempting to restart Ollama..."
            export OLLAMA_HOST=0.0.0.0:11543
            export OLLAMA_MODELS=/home/runner/.ollama/models
            export OLLAMA_ORIGINS="*"
            export OLLAMA_KEEP_ALIVE=30m
            nohup ollama serve > logs/ollama-server-restart.log 2>&1 &
            echo $! > logs/ollama.pid
            sleep 5
          fi
          
          if ! pgrep -f ngrok >/dev/null; then
            echo "❌ WARNING: ngrok process not found!"
            HEALTH_STATUS="❌"
            # Attempt to restart ngrok
            echo "🔄 Attempting to restart ngrok..."
            nohup ngrok http 11543 --log=stdout > logs/ngrok-restart.log 2>&1 &
            echo $! > logs/ngrok.pid
            sleep 5
          fi
          
          # API health check
          if ! curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
            echo "⚠️  Ollama API not responding"
            HEALTH_STATUS="⚠️"
          fi
          
          # Status report every 5 minutes
          if [[ $((ELAPSED % 300)) -lt 30 ]] && [[ $ELAPSED -gt 30 ]]; then
            echo "📊 5-minute status report ($(date -u '+%Y-%m-%d %H:%M:%S UTC')):"
            echo "  🔥 Health: $HEALTH_STATUS"
            echo "  💾 Memory: $(free -h | grep Mem: | awk '{print $3"/"$2}')"
            echo "  🖥️  CPU Load: $(uptime | awk -F'load average:' '{ print $2 }')"
            echo "  💿 Disk: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
            
            # Show current tunnel URL
            CURRENT_TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
            if [[ -n "$CURRENT_TUNNEL_URL" && "$CURRENT_TUNNEL_URL" != "null" ]]; then
              echo "  🌐 Tunnel: $CURRENT_TUNNEL_URL"
            else
              echo "  ⚠️  Tunnel: URL not available"
            fi
            
            # Show running models
            export OLLAMA_HOST=0.0.0.0:11543
            echo "  🤖 Active models:"
            ollama ps 2>/dev/null || echo "    Unable to fetch active models"
          fi
          
          sleep 30
        done
        
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Keep-alive completed" >> logs/timeline.log
        
    - name: 📊 Final Status Report
      if: always()
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Generating final report" >> logs/timeline.log
        
        echo "==================== FINAL STATUS REPORT ===================="
        echo "🕐 Workflow ending at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # Server status
        echo ""
        echo "🖥️  OLLAMA SERVER STATUS:"
        if curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
          echo "  ✅ Status: Running and responding"
          echo "  📍 Local endpoint: http://0.0.0.0:11543"
        else
          echo "  ❌ Status: Not responding"
        fi
        
        # Tunnel status
        echo ""
        echo "🌐 NGROK TUNNEL STATUS:"
        if pgrep -f ngrok >/dev/null; then
          echo "  ✅ Process: Running (PID: $(pgrep -f ngrok))"
          
          # Get tunnel details
          TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
          if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" != "null" ]]; then
            echo "  🌐 Public URL: $TUNNEL_URL"
            echo "  📡 API Access: $TUNNEL_URL/api/tags"
          else
            echo "  ⚠️  Public URL: Not available"
          fi
        else
          echo "  ❌ Process: Not running"
        fi
        
        # Resource usage
        echo ""
        echo "💾 RESOURCE USAGE:"
        echo "  Memory:"
        free -h | sed 's/^/    /'
        echo "  CPU Load: $(uptime | awk -F'load average:' '{ print $2 }')"
        echo "  Disk:"
        df -h / | sed 's/^/    /'
        
        # Model status
        echo ""
        echo "🤖 MODEL STATUS:"
        export OLLAMA_HOST=0.0.0.0:11543
        if ollama list 2>/dev/null; then
          ollama list | sed 's/^/  /'
        else
          echo "  Unable to retrieve model list"
        fi
        
        # Process status
        echo ""
        echo "🔄 RUNNING PROCESSES:"
        ps aux | grep -E "(ollama|ngrok)" | grep -v grep | sed 's/^/  /' || echo "  No relevant processes found"
        
        # Cache information
        echo ""
        echo "💾 CACHE STATUS:"
        echo "  📦 Ollama models: ${{ steps.cache-ollama-models.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
        echo "  📦 Ollama binary: ${{ steps.cache-ollama-bin.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
        
        # Logs summary
        echo ""
        echo "📁 GENERATED LOGS:"
        if [[ -d logs ]]; then
          ls -lah logs/ | sed 's/^/  /'
        else
          echo "  No logs directory found"
        fi
        
        # Timeline
        echo ""
        echo "📜 WORKFLOW TIMELINE:"
        if [[ -f logs/timeline.log ]]; then
          cat logs/timeline.log | sed 's/^/  /'
        else
          echo "  No timeline log found"
        fi
        
        # ngrok logs summary
        echo ""
        echo "🌐 NGROK TUNNEL LOGS (last 10 lines):"
        if [[ -f logs/ngrok.log ]]; then
          tail -10 logs/ngrok.log | sed 's/^/  /'
        else
          echo "  No ngrok logs found"
        fi
        
        echo ""
        echo "============================================================"
        
    - name: 🧹 Cleanup Processes
      if: always()
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Starting cleanup" >> logs/timeline.log
        echo "🧹 Cleaning up processes..."
        
        # Stop monitoring
        if [[ -f logs/main-monitor.pid ]]; then
          MONITOR_PID=$(cat logs/main-monitor.pid)
          kill $MONITOR_PID 2>/dev/null || true
          echo "✅ Monitor process stopped"
        fi
        
        # Stop ngrok
        if [[ -f logs/ngrok.pid ]]; then
          NGROK_PID=$(cat logs/ngrok.pid)
          kill $NGROK_PID 2>/dev/null || true
          echo "✅ ngrok process stopped"
        fi
        
        # Stop Ollama gracefully
        if [[ -f logs/ollama.pid ]]; then
          OLLAMA_PID=$(cat logs/ollama.pid)
          kill $OLLAMA_PID 2>/dev/null || true
          echo "✅ Ollama process stopped"
        fi
        
        # Wait for graceful shutdown
        sleep 5
        
        # Force kill any remaining processes
        sudo pkill -f ngrok || true
        sudo pkill -f ollama || true
        
        echo "✅ All processes cleaned up"
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - Cleanup completed" >> logs/timeline.log
        
    - name: 💾 Upload Comprehensive Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ollama-server-logs-${{ github.run_id }}
        path: logs/
        retention-days: 7
        
    - name: 📝 Create Summary
      if: always()
      run: |
        echo "## 📊 Ollama Server Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Basic info
        echo "### 📋 Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Model**: ${{ github.event.inputs.model || 'qwen2.5:0.5b' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run**: [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Started**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Tunnel info
        echo "### 🌐 ngrok Tunnel" >> $GITHUB_STEP_SUMMARY
        TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
        if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" != "null" ]]; then
          echo "- **Status**: ✅ Active" >> $GITHUB_STEP_SUMMARY
          echo "- **Public URL**: [$TUNNEL_URL]($TUNNEL_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **API Test**: [$TUNNEL_URL/api/tags]($TUNNEL_URL/api/tags)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: ❌ URL not available" >> $GITHUB_STEP_SUMMARY
          echo "- **Note**: Check ngrok logs for connection issues" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # API Endpoints
        echo "### 🔌 API Endpoints" >> $GITHUB_STEP_SUMMARY
        if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" != "null" ]]; then
          echo "All endpoints are accessible via your ngrok tunnel:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$TUNNEL_URL/api/generate" >> $GITHUB_STEP_SUMMARY
          echo "$TUNNEL_URL/api/chat" >> $GITHUB_STEP_SUMMARY
          echo "$TUNNEL_URL/api/embeddings" >> $GITHUB_STEP_SUMMARY
          echo "$TUNNEL_URL/api/tags" >> $GITHUB_STEP_SUMMARY
          echo "$TUNNEL_URL/api/show" >> $GITHUB_STEP_SUMMARY
          echo "$TUNNEL_URL/api/ps" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "Endpoints not available - tunnel URL could not be retrieved." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Example usage
        echo "### 💡 Example Usage" >> $GITHUB_STEP_SUMMARY
        if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" != "null" ]]; then
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Test the connection" >> $GITHUB_STEP_SUMMARY
          echo "curl $TUNNEL_URL/api/tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Generate a response" >> $GITHUB_STEP_SUMMARY
          echo "curl $TUNNEL_URL/api/generate \\" >> $GITHUB_STEP_SUMMARY
          echo "  -d '{" >> $GITHUB_STEP_SUMMARY
          echo '    "model": "${{ github.event.inputs.model || 'qwen2.5:0.5b' }}",' >> $GITHUB_STEP_SUMMARY
          echo '    "prompt": "Hello, how are you?",' >> $GITHUB_STEP_SUMMARY
          echo '    "stream": false' >> $GITHUB_STEP_SUMMARY
          echo "  }'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "Example usage not available - tunnel URL could not be retrieved." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Status
        echo "### ✅ Final Status" >> $GITHUB_STEP_SUMMARY
        if curl -sf http://0.0.0.0:11543/api/tags >/dev/null 2>&1; then
          echo "- ✅ Ollama server: **Running**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ Ollama server: **Stopped**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if pgrep -f ngrok >/dev/null; then
          echo "- ✅ ngrok tunnel: **Active**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ ngrok tunnel: **Inactive**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📂 Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- [Download Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
